# 9 Машин програм VI: Buffer overflow

## Дараах кодод байгаа get_line функцыг 0х400776 буцах хаягтайгаар дуудсан ба гх регистрын утга Ох 0123456789ABCDEF байсан. Та

```text
0123456789012345678901234
```

## гэсэн утгыг гараас оруулахад програм segmentation fault алдагаар өгсөн. Та GDB програмыг ажиллуулан алдааг шалгатал алдаа ret тушаалыг гүйцэтгэх үед гарсан байсан

```c
char *getline()
{
    char but[4];
    char *result;
    gets(buf);
    result = malloc(strlen(buf)); 
    strcpy(result, buf);
    return result;
}
```

## gets хүртэл disassemble хийсэн код

```text
1: 0000000000400720 <get_line> 
2: 400720: 53               push %rbx
3: 400721: 48 83 ос 10      sub $0x10, %rsp 
4: 400725: 48 89 e7         mov %rap, %rdi
5: 400728: 68 73 ff ff ff   callq 4006a0 <gets>
```

## 1. 3-р мөрөн дахь үйлдэл хийгдсэн дараагаас эхлэн стак юу хадгалах талаар дараах хүснэгтийг нөх. Хүснэгтийн зүүн талд хадгалагдсан утга, баруун талд энэ нь ямар мэдээлэл болохыг бич (жишээ нь буцах хаяг). Хүснэгтийн мөр бүр 8 байт мэдээлэл дүрсэлнэ. Хrsp аль мөрийг зааж байгааг илтгэ. AЅСI кодын 0-9 утга 16-тын 0х30-0х39 болохыг анхаарна уу

 |                         |                          |
 | ----------------------- | ------------------------ |
 | 00 00 00 00 00 40 07 76 | Буцах утга               |
 | 01 23 45 67 89 AB CD EF | %rbx-д хадгалагсан утга  |
 |                         |                          |
 |                         | <-buf = %rsp             |
 |                         |                          |

## 2. gets үйлдэл хийгдсэний дараах дээрх хүснэгтийн зураглалыг дахин зур

 |                         |                          |
 | ----------------------- | ------------------------ |
 | 00 00 00 00 00 40 07 76 | Буцах утга               |
 | 01 23 45 67 89 AB CD EF | %rbx-д хадгалагсан утга  |
 | 35 34 33 32 31 30 39 38 |                          |
 | 37 36 35 34 33 32 31 30 | <-buf = %rsp             |
 |                         |                          |

## 3. Уг програм ямар хаягруу буцахыг оролдож байна вэ?

```text
Програм 0x040034 хаяг руу буцахыг оролдож байна. Доод эрэмбийн 2 байтыг ‘4’ тэмдэгт болон төгсгөлийн null тэмдэгтийн кодоор дарж бичсэн.
```

## 4. get_line функц буцахдаа ямар регистр(үүдийн) доторыг балалсан байх вэ?

```text
%rbx регистрийн хадгалсан утгыг 0x3332313039383736 гэж
```

## 5. Буфер хэтрэх алдаанаас өөр ямар ноцтой алдаанууд get_line функцэд байна вэ?

```text
Malloc-г дуудахад аргумент strlen(buf)+1 байх ёстой бөгөөд код нь буцаасан утга нь NULL-тэй тэнцүү биш эсэхийг шалгах ёстой.
```
